Linux Gold Images in AWS
Linux Gold Images are ready to use operating system images currently produced in AWS in AMI format for the following distributions:

Amazon Linux 2
Red Hat Enterprise Linux 7
Red Hat Enterprise Linux 8
The images are produced weekly and deleted after 4 weeks. Thus, at any given time there will be 4 images available for the PDUs to chose from.
The images are shared with all PDUs.
Please note, minor version images (e.g. RHEL7.1, or RHEL 8.4) are not provided. The images will practically have the latest published minor version of the Operating System.

Pre-requisites

In AWS, the images are provided unencrypted, and have a short lifespan, therefore they must not be used directly.
The use of t2 AWS instances with the Gold Images is not supported, due to the instance low performance.
In AWS, an EC2 instance should be launched in the consuming (i.e. your) account using the shared Gold AMI, and then a new AMI must be created from that instance. The EBS volumes must be encrypted using your own KMS key when the new AMI is created.

This must be done in both production and non-production accounts. You can then use your newly created AMI however you want.

Usage

To use these images, pleasecheck out the following runbooks:

AWS Infrastructure as Code (IaC) Guide for Linux, Including Encryption
AWS Console Guide
How to add an EBS Volume
Please note that the use of AWS console for consuming the Gold Images is discouraged, but the runbook above is provided for reference.

Image details

The image builds are performed at the moment by Gitlab.com runners using the gold-build repositories which are documented in README files and inline comments. More details for Gold Image developers will be provided in Chorlton soon.

The Linux images have the following particularities:

Amazon Linux 2RHEL 7RHEL 8
Amazon Linux 2

Item	Configuration	Details
Prefixes	2	
AMZN2-AWS-CIS2-20* for the dual-volume AMI; and
AMZN2-SINGLEVOL-AWS-CIS2-20*for the single-volume AMI
Hardening	CIS2	About CIS2 Hardening
Agents	3	TrendMicro Deep Security, Tanium Client and Tenable are all stored on the image but not installed
Firewall	iptables	Traditional firewall utility
Dual volume AMI AWS volume type	EBS gp3	Both root volume and additional volume use the newer AWS gp3 volume type to deliver an improved cost performance ratio
Single volume AMI AWS volume type	EBS gp3	Single volume now uses the newer AWS gp3 volume type to deliver an improved cost performance ratio
Dual volume AMI	✅	A build with an extra volume of 50 GB is provided, withsome directoriessuch as /var or/opt mounted on it.
Single volume AMI	✅	
An alternative AMI, having a single 30 GB EBS volume is also provided, havingsimilar mountpoints
If the instance is launched with a bigger than 30GB EBS volume, the extra space will be added to the volume group, but the logical volumes will remain the same size. Here is an example of how to extend a logical volume:
lvextend -L +1G /dev/rootvg/tmpvol
xfs_growfs /dev/mapper/rootvg-tmpvol
SSH Access	✅	SSH access is allowed only from internal (RFC1918) IP addresses.
SSM access	✅	SSM agent is installed, but additional configuration is required in the AWS account
AWS CLI	v1 andv2	AWS CLI v1 is enabled by default, but can be easily switched to v2 with a single command
Other apps	✅	CloudWatch agent and SSM agent are installed. CloudWatch agent requires further configuration specific to each account. Please use these instructions to configure memory metrics as required by FinOps
Python PIP	Python 3	AWS Gold Images contain pip3 but there is no pip module installed for Python 2
Patching	Daily	Patching applies minimal critical security updates, as recommended by AWS forAmazon-Linux-2
CIS Exemptions

CIS hardening is applied to images and currently verified by the CIS-CAT assessor. We have a list of known exemptions to the CIS2 hardening for each image which is checked as part of the testing process to ensure the image is produced as expected.

Details of these exemptions can be found on this page.

IPv6

IPv6 is now disabled in the Gold Images as part of the grub configuration. This is as recommended by CIS.

Installing the Agents

To install any of the agents please see here.

Memory Optimisation Settings

In AWS, the reserved kernel memory (vm.min_free_kbytes) is set to 3% of the machine RAM at boot time, as recommended by AWS, but not lower than the vm.min_free_kbytes default boot-time value. To view this value, run the following command:

sysctl -n vm.min_free_kbytes
Most of the time, this setting should be left as is. To disable this optimisation if required, the following command must be used:

systemctl disable --now vmminfree
This will immediately revert the vm.min_free_kbytes back to boot-time value and will not touch it again on subsequent reboots.

Extending the disk for single volume Gold Images

Single volume images come with a minimal, single root volume attached, around 15 GB in size. The Gold Images do not have a script or service to automatically adjust partitions, LVM volumes, or filesystems when EBS volume is resized as there are too many use cases to do that safely.

To increase the partition and LVM size, first create an EC2 machine with a larger root volume, e.g. using Terraform. The following example assumes the root volume is /dev/nvme0n1. Then, execute the following:

# Extends the LVM partition boundary to the end of the EBS volume
growpart /dev/nvme0n1 1
# Extends the LVM PV to the end of the LVM partition extended above
pvresize /dev/nvme0n1p1
# Extends /var to occupy all the added space
lvextend --extents +100%FREE --resizefs /dev/goldvg/varvol
# Show the new LVM volume sizes
df -h
To increase the space by a limited amount (e.g. 5 GB), as opposed to all added space, the lvextend command will be:

lvextend -L +5G
Changing the Default AWS CLI to Version 2

The images contain both v1 and v2 of the AWS CLI, with v1 as the default for maximum compatibility with any existing scripts a PDU may have.

To make v2 the default, execute the following single command as theroot user:

alternatives --remove awscli /opt/awsclivenv/bin/aws
Patching and Updates

The details for security patching or software updates can be foundhere.

Instance access using SSM

The inclusion of the SSM agent does not immediately enable instances to be accessed via AWS Systems Manager, as additional IAM permission are required. These are documentedhere. The SSM agent enables other AWS functionality that does not require the IAM permissions.

Feedback

If you any questions, please drop us an email: hcs-gold-images@engineering.digital.dwp.gov.uk or visit hcs-gold-images on slack.


Could you improve this content?
Contributions are welcome. This content is managed on GitLab.
