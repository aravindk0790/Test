---
 variables: &global_variables
  HTTP_PROXY: http://proxy.local.dwpcloud.uk:3128
  HTTPS_PROXY: http://proxy.local.dwpcloud.uk:3128
  http_proxy: http://proxy.local.dwpcloud.uk:3128
  https_proxy: http://proxy.local.dwpcloud.uk:3128
  HELM_CHART_VERSION: 0.41.4
  AWS_REGION: "eu-west-2"
default:
  tags:
    - zimperium-hcs-runner
    
stages:
  - deploy
  - quality_gate
  
.deploy_template: &deploy_definition
  stage: deploy
  image:
    name: zegl/kube-score:latest-helm3@sha256:efabbca3302c632233d6d2e83dec531c7e5b3c5ac5650709f41b0d1ee1b134c7
    entrypoint: [""]
    
  script:
    - apk update
    - apk add --no-cache aws-cli jq curl

    # Install kubectl and set path    
    - curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.23.17/2023-05-11/bin/linux/amd64/kubectl
    - chmod +x ./kubectl
    - mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$HOME/bin:$PATH
    - mv ./kubectl /usr/local/bin/kubectl
    - echo 'export PATH=$HOME/bin:$PATH' >> ~/.bashrc
    - kubectl version --short --client

    # Assume EKS Namespace Role   
    - TEMP_ROLE=$(aws sts assume-role --role-arn arn:aws:iam::${AWS_ACCOUNT}:role/${AWS_ROLE} --role-session-name hcs-eks-runner-eks)
    - export AWS_ACCESS_KEY_ID=$(echo $TEMP_ROLE | jq -r .Credentials.AccessKeyId)
    - export AWS_SECRET_ACCESS_KEY=$(echo $TEMP_ROLE | jq -r .Credentials.SecretAccessKey)
    - export AWS_SESSION_TOKEN=$(echo $TEMP_ROLE | jq -r .Credentials.SessionToken)
    - aws sts get-caller-identity
  
    # Login to ECR
    - export HELM_EXPERIMENTAL_OCI=1
    - aws ecr get-login-password --region ${AWS_REGION} | helm registry login --username AWS --password-stdin ${AWS_ACCOUNT}.dkr.ecr.${AWS_REGION}.amazonaws.com  
    
    # Login to EKS Cluster
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${ENVIRONMENT}-eks-cluster
    - kubectl config view
    - kubectl config current-context
    - kubectl config set-context --current --namespace=$NAMESPACE
  
    # Create common EFS volume used by Content, ZConsole & Wotification-Worker
    - kubectl apply -f zimp_efs_pvc.yaml -n $NAMESPACE
  
    # Configure network policy to allow pods to communicate and ingress from ISTIO gateway
    - kubectl apply -f ${CI_PROJECT_DIR}/zimp_network_policy.yaml --namespace=$NAMESPACE
    
    # install redis component separately
    - helm upgrade -i elasticcache -n $NAMESPACE k8s/helm/elasticcache --values global_${ENVIRONMENT}.yaml --values k8s_manifest.yaml --wait --debug 
    
    # Workaround - deploy dummy email smtp server
    - kubectl apply -f ${CI_PROJECT_DIR}/zimp_smtp_stub.yaml --namespace=$NAMESPACE
    
    # It will show status of the ongoing operation
    - helm version 
    - helm ls -a -n $NAMESPACE
    - chmod +x ./bin/install.sh 
  
    # # # Run Zimperium installation script
    - bin/install.sh -n $NAMESPACE
    
    # Configure Ingress to Zimperium via HCS ISTIO gateway
    - kubectl apply -f ${CI_PROJECT_DIR}/zimp_ingress_${ENVIRONMENT}.yaml --namespace=$NAMESPACE

.test_template: &test_definition
  stage: test
  image: 
    name: zegl/kube-score:latest-helm3@sha256:efabbca3302c632233d6d2e83dec531c7e5b3c5ac5650709f41b0d1ee1b134c7
    entrypoint: [""]
  script:
    # Assume EKS Namespace Role 
    - TEMP_ROLE=$(aws sts assume-role --role-arn arn:aws:iam::${AWS_ACCOUNT}:role/${AWS_ROLE} --role-session-name hcs-eks-runner-eks)
    - export AWS_ACCESS_KEY_ID=$(echo $TEMP_ROLE | jq -r .Credentials.AccessKeyId)
    - export AWS_SECRET_ACCESS_KEY=$(echo $TEMP_ROLE | jq -r .Credentials.SecretAccessKey)
    - export AWS_SESSION_TOKEN=$(echo $TEMP_ROLE | jq -r .Credentials.SessionToken)
    
     # Login to EKS Cluster
    - aws eks update-kubeconfig --region ${AWS_REGION} --name ${ENVIRONMENT}-eks-cluster
    
    # Run Kube score on all the application
    # - kubectl api-resources --verbs=list --namespaced -o name | xargs -n1 -I{} bash -c "kubectl get {} -n ${NAMESPACE} -oyaml && echo ---" | kube-score score -

    - helm template java -n mobility-zimperium-apps k8s/helm/java  --values global.yaml --values k8s_manifest.yaml --wait | kube-score score -
    - helm template releasev5 -n mobility-zimperium-apps k8s/helm/releasev5  --values global.yaml --values k8s_manifest.yaml --wait | kube-score score -
    - helm template kafka -n mobility-zimperium-apps k8s/helm/kafka --values global.yaml --values k8s_manifest.yaml --wait | kube-score score -
    - helm template utilities -n mobility-zimperium-apps k8s/helm/utilities  --values global.yaml --values k8s_manifest.yaml --wait | kube-score score -
    - helm template elasticcache -n mobility-zimperium-apps k8s/helm/elasticcache  --values global.yaml --values k8s_manifest.yaml --wait | kube-score score -
    - helm template infrastructure -n mobility-zimperium-apps k8s/helm/infrastructure  --values global.yaml --values k8s_manifest.yaml --wait | kube-score score -
    - helm template python -n mobility-zimperium-apps k8s/helm/python  --values global.yaml --values k8s_manifest.yaml --wait | kube-score score -

deploy:dev:
    <<: *deploy_definition
    variables:
        <<: *global_variables
AWS_ACCOUNT: ${AWS_DEV_ACCOUNT}
ENVIRONMENT: "pdu-dev"
AWS_ROLE : ${AWS_DEV_ROLE}
except:
  - main
  - /^release-.*$/        
deploy:test:
    <<: *deploy_definition
    variables:
        <<: *global_variables
AWS_ACCOUNT: ${AWS_TEST_ACCOUNT}
ENVIRONMENT: "pdu-test"
AWS_ROLE : ${AWS_TEST_ROLE}
except:
  - main
  - /^release-.*$/
deploy:stage:
    <<: *deploy_definition
    variables:
        <<: *global_variables
  AWS_ACCOUNT: ${AWS_STAGE_ACCOUNT}
  ENVIRONMENT: "pdu-stage"
  AWS_ROLE : ${AWS_STAGE_ROLE}
    only:
        - /^release-.*$/
    
deploy:prod:
    <<: *deploy_definition
    variables:
        <<: *global-variables
  AWS_ACCOUNT: ${AWS_PROD_ACCOUNT}
  ENVIRONMENT: "pdu-prod"
  AWS_ROLE : ${AWS_PROD_ROLE}
    only:
        - main
  
quality_gate:dev:
  <<: *test_definition
  variables:
     ENVIRONMENT: "pdu-dev"
     AWS_ACCOUNT: ${AWS_DEV_ACCOUNT} 
     AWS_ROLE : ${AWS_DEV_ROLE}
  except:
     - main
     - /^release-.*$/
   
quality_gate:test:
  <<: *test_definition
  variables:
     ENVIRONMENT: "pdu-test"
     AWS_ACCOUNT: ${AWS_TEST_ACCOUNT} 
     AWS_ROLE : ${AWS_TEST_ROLE}
  except:
     - main
     - /^release-.*$/
   
quality_gate:stage:
  <<: *test_definition
  variables:
     ENVIRONMENT: "pdu-stage"
     AWS_ACCOUNT: ${AWS_STAGE_ACCOUNT}
     AWS_ROLE : ${AWS_STAGE_ROLE}
  only:
     - /^release-.*$/
     
quality_gate:prod:
  <<: *test_definition
  variables:
     ENVIRONMENT: "pdu-prod"
     AWS_ACCOUNT: ${AWS_PROD_ACCOUNT}  
     AWS_ROLE : ${AWS_PRO_ROLE}
  only:
     - main
